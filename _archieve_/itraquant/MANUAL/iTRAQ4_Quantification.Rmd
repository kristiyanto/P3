---
title: | 
  | Portable Proteomics Pipeline (P3) 
  | Labelled (iTRAQ4) Quantification
author: "Daniel Kristiyanto (daniel.kristiyanto@pnnl.gov)"
date: \today
fontsize: 11pt
output: pdf_document
bibliography: ../../media/ref.bib
nocite: |
  @domon2006mass, @deutsch2010mass, @MSnba83
csl: ../../media/biomed-central.csl
header-includes:
  \usepackage{fancyhdr}
  \usepackage{graphicx}
  \usepackage{hyperref}
  \pagestyle{fancy}
  \setlength\headheight{28pt}
  \rhead{\includegraphics[width = .2\textwidth]{../../media/pnnllogo.png}}
  \fancyfoot[LE,RO]{kristiyanto/p3:itraquant}
---
\rule{\textwidth}{1pt}
Portable Proteomics Pipeline (P3) is a series of protein mass spectrometry data pre-processing pipelines in Docker containers. The packages includes protein identification, filtering, and quantification for both labeled and label-free mass spectrometry data.

This document discuss the ```kristiyanto/p3:itraquant``` container, a spectrum count quantification pipeline for label-free mass spectrometry protein quantification. The pipeline is based on MSNbase pipeline [@msnbase].

#Input
The container takes the following files: 
```
p3.config # Configuration file
*.mzid    # mzIdentML files resulted from p3:msgf container or other identification tools.
*.mzML    # Mass Spectrometer output files
```

```p3.config``` may contain various parameters for p3 related containers. To run spectrum count quantification, ```p3.config``` must contain the following information:

```
[itraq4]
evalue_treshold = 1e-10 # Evalue treshold. Features with evalue higher than 
                # this value will be discarded. 
                # Check MSNbase: removeNoID documentation for more detailed information.
pNA    = 0      # 0 to 1. Ratio of NA allowed for a feature. 
                # 0 indicates that features with any missing value will be discarded. 
                # Check MSNbase: filterNA documentation for more detailed information.
quant_method = sum      # Quantification method.
                # Check MSNbase: quantify documentation for more detailed information.
combine_by = mean       # Function used for feature aggregation.
                # Check MSNbase: combineFeatures for more detailed documentation for more detailed information.
```
#Running the Container
to run the container, a docker engine must be installed. A more information about installing Docker engine is available at \url{https://docs.docker.com/engine/installation/}. Input files must be mounted to ```/root/data``` within the container. This can be done by using ```-v``` switch. For MacOS and Windows users, the folder should be located under ```C:\Users``` or ```/Users/```. More information about volumens in Docker containers is available at \url{http://container-solutions.com/understanding-volumes-docker/}


```
# Download/update the container from DockerHub
docker pull kristiyanto/p3:itraquant   
# Run the container
docker run --rm -v /Users/path/files:/root/data kristiyanto/p3:itraquant
```

#Output
Once the quantification process is completed, ```LabelledQuant.txt```, ```evalue.txt```, and ```msnset.rda``` are generated. ```LabelledQuant.txt``` is a tab delimited file with the quantification results, with each column represented from each of the ```mzML``` file provided. ```evalue.txt``` is the raw data of the identification and evalue for each features. ```msnset.rda``` is an msnset object for the final result that can be easily imported to R for additional analysis.

# Pipeline
```kristiyanto/p3:scquant``` is based on R, and it uses MSNbase [@msnbase] package and pipeline. A more detailed information about the pipeline is available at \url{http://bioconductor.org/packages/release/bioc/vignettes/MSnID/inst/doc/msnid_vignette.pdf}.

For this documentation, three paired of experiment files are processed.

```{r echo=FALSE,warning=FALSE, message=FALSE}
library("ggplot2")
library(MSnbase)
library(mzID)
library(stringr)
setwd("~/Desktop/tcga/")
load("itraq_results.RData")

```

```{r}
# Files
print(mzid.files)
print(mzml.files)
```

## Identification
Identification is performed by using ```addIdentificationData()``` function from MSnBase package.

```{r}
idSummary(msexp.id)
fData(msexp.id)[1:3,]
```

## Filter
Filtering is done by: 1) Removing unidentified features, and features with e-value higher than ```evalue_treshold``` value described in ```p3.config```. 2) features that are asssigned by multiple protein groups.

```{r}
# Prior Filtering
length(msexp.id)
print(evalue_treshold)
k                 <- (fData(msexp.id)$'ms-gf:evalue'< evalue_treshold)
k[is.na(k)]       <- FALSE
print(sum(k)) # Number of kept features
msexp.filter1     <- removeNoId(msexp.id, keep=k)
# Subsquent evalue filter
length(msexp.filter1)
msexp.filter2     <- removeMultipleAssignment(msexp.filter1)
# Subsquent multiple assigment filter
length(msexp.filter2)
fData(msexp.filter2)[1:3,]
```

##Quantification
Quantification is done by using the MSnBase package [@msnbase], with method specified on the `p3.config` file.
```{r}
head(exprs(qnt))
print(pNA)
qnt.filtered      <- filterNA(qnt, pNA = pNA)
head(exprs(qnt.filtered))
```

##Results
subsequently, the features are aggregated by accession ID, with the value calculated using the function denoted on the `p3.config`.
```{r}
length(exprs(qnt.filtered))
result  <- combineFeatures(qnt.filtered, groupBy = fData(qnt.filtered)$accession, fun=combine_by)
length(exprs(result))
head(exprs(result))
```

# References