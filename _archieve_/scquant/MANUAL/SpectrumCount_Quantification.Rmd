---
title: | 
  | Portable Proteomics Pipeline (P3) 
  | Spectrum Count Quantification
author: "Daniel Kristiyanto (daniel.kristiyanto@pnnl.gov)"
date: \today
fontsize: 11pt
output: pdf_document
bibliography: ../../media/ref.bib
csl: ../../media/biomed-central.csl
header-includes:
  \usepackage{fancyhdr}
  \usepackage{graphicx}
  \usepackage{hyperref}
  \pagestyle{fancy}
  \setlength\headheight{28pt}
  \rhead{\includegraphics[width = .2\textwidth]{../../media/pnnllogo.png}}
  \fancyfoot[LE,RO]{kristiyanto/p3:scquant}
---
\rule{\textwidth}{1pt}
Portable Proteomics Pipeline (P3) is a series of protein mass spectrometry data pre-processing pipelines in Docker containers. The packages includes protein identification, filtering, and quantification for both labeled and label-free mass spectrometry data.

This document discuss the ```kristiyanto/p3:scquant``` container, a spectrum count quantification pipeline for label-free mass spectrometry protein quantification. The pipeline is based on MSnID pipeline [@msnid, @MSnID31].

#Input
The container takes the following files: 
```
p3.config # Configuration file
*.mzid    # mzIdentML files resulted from p3:msgf container or other identification tools.
```

```p3.config``` may contain various parameters for p3 related containers. To run spectrum count quantification, ```p3.config``` must contain the following information:

```
[spectrum_count]
score_treshold = 7.0  # The scoring treshold 
error_treshold = 20   # Error Treshold
fdr = 0.01            # False Discovery Rate
iteration = 5000      # Number of iteration

```
#Running the Container
to run the container, a docker engine must be installed. A more information about installing Docker engine is available at \url{https://docs.docker.com/engine/installation/}. Input files must be mounted to ```/root/data``` within the container. This can be done by using ```-v``` switch. For MacOS and Windows users, the folder should be located under ```C:\Users``` or ```/Users/```. More information about volumens in Docker containers is available at \url{http://container-solutions.com/understanding-volumes-docker/}


```
# Download/update the container from DockerHub
docker pull kristiyanto/p3:squant   
# Run the container
docker run --rm -v /Users/path/files:/root/data kristiyanto/p3:scquant
```

#Output
Once the quantification process is completed, ```LabelFreeQuant.txt``` and ```msnset.rda``` are generated. ```LabelFreeQuant.txt``` is a tab delimited file with the quantification results, with each column represented from each of the ```mzid``` file provided. ```msnset.rda``` is an msnset object for the result that can be easily imported to R for additional analysis.

# Pipeline
```kristiyanto/p3:scquant``` is based on R, and it uses MSnID package and pipeline. A more detailed information about the pipeline is available at \url{http://bioconductor.org/packages/release/bioc/vignettes/MSnID/inst/doc/msnid_vignette.pdf}.

For this documentation, three ```mzid``` files are processed.

```{r echo=FALSE,warning=FALSE, message=FALSE}
library("ggplot2")
library("rpx")
library("mzID")
library("MSnID")
library("MSnbase")
setwd("~/Desktop/biodiversity/")
load("scquant_results.RData")
pepCleav <- unique(psms(mzid)[,c("numMissCleavages", "isDecoy", "peptide")])
pepCleav <- as.data.frame(table(pepCleav[,c("numMissCleavages", "isDecoy")]))
```

```{r}
# Files
print(mz.files)
prop.table(table(mzid$numIrregCleavages))
```


```{r echo=FALSE}
ggplot(pepCleav, aes(x=numMissCleavages, y=Freq, fill=isDecoy)) + geom_bar(stat='identity', position='dodge')+ggtitle("Number of Missed Cleavages")
```

## Filter
Filtering is done by using the parameter defined in the ```p3.config``` file. The filtering is including the error calculation (`variable: error_treshold`), scoring (`variable: score_treshold`), and filter optimization (`variable: iteration and fdr`) [@deutsch2010mass, @MSnID31].
```{r}
show(mzid)
show(fObj)
evaluate_filter(prj, fObj, level="PSM")
evaluate_filter(prj, fObj, level="peptide")
evaluate_filter(prj, fObj, level="accession")
show(prj)
```
##Quantification
Quantification is done by using the MSnBase package [@msnbase].
```{r}
msnset  <- as(prj, "MSnSet")
msnset  <- combineFeatures(msnset, fData(msnset)$accession, redundancy.handler="unique", 
                           fun="sum",cv=FALSE)
```

##Results
```{r}
exprs.table     <- exprs(msnset)
exprs.table     <- cbind(Protein=row.names(exprs.table), as.data.frame(exprs.table))
head(exprs.table)
```

# References